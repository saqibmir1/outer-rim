<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ "icons/favicon.ico" | absURL }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Star Wars Fonts - Exact same as original site -->
    <link href="https://fonts.cdnfonts.com/css/star-wars" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/rastaglion" rel="stylesheet">
    
    <!-- Inter Font for better readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Star Wars CSS -->
    <link rel="stylesheet" href="{{ "css/star-wars.css" | absURL }}">
    
    <!-- Original theme head content -->
    {{- partial "head.html" . -}}
    
    <!-- Meta Description -->
    <meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body data-theme="{{ .Site.Params.defaultColor }}" class="star-wars-body">
    {{- partial "scriptsBodyStart.html" . -}}
    
    <!-- Star Wars Header -->
    <header class="star-wars-header">
        <div class="header-title">{{ .Site.Title }}</div>
        
        <!-- Background Music Player -->
        <div class="music-player-widget">
            <button id="musicToggle" class="music-btn" title="Toggle Imperial March">
                <i class="fas fa-music"></i>
            </button>
            <div class="music-status" id="musicStatus">Click to play Imperial March</div>
        </div>
    </header>
    
    <!-- Star Wars Navigation -->
    {{- partial "star-wars-nav.html" . -}}
    
    <hr class="star-wars-divider">
    
    <!-- Animated Star Background -->
    <div class="starfield">
        <div class="stars" id="star1"></div>
        <div class="stars" id="star2"></div>
    </div>
    
    <!-- Main Content -->
    <main class="star-wars-main">
        {{- block "main" . }}{{- end }}
    </main>
    
    <!-- Footer -->
    {{- partial "footer.html" . -}}
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    
    <!-- Background Music Player Script -->
    <script>
    (function() {
        // Use a global audio object that persists across pages
        window.starWarsAudio = window.starWarsAudio || null;
        
        let audio = window.starWarsAudio;
        let isPlaying = false;
        let isLoaded = false;
        
        const musicToggle = document.getElementById('musicToggle');
        const musicStatus = document.getElementById('musicStatus');
        
        // Get saved music state from localStorage
        const savedMusicState = localStorage.getItem('starWarsMusic');
        const shouldAutoPlay = savedMusicState === 'playing';
        
        function createAudio() {
            if (!audio) {
                audio = new Audio('/audio/imperial.mp3');
                audio.loop = true;
                audio.volume = 0.3;
                
                // Store globally so it persists across pages
                window.starWarsAudio = audio;
                
                // Restore saved time position
                const savedTime = localStorage.getItem('starWarsMusicTime');
                if (savedTime) {
                    audio.currentTime = parseFloat(savedTime);
                }
                
                audio.addEventListener('canplaythrough', function() {
                    isLoaded = true;
                    updateUI();
                    if (shouldAutoPlay && !isPlaying) {
                        playMusic();
                    }
                });
                
                audio.addEventListener('error', function() {
                    musicStatus.textContent = 'Music unavailable';
                    musicToggle.style.opacity = '0.5';
                });
                
                audio.addEventListener('timeupdate', function() {
                    // Save current time position
                    localStorage.setItem('starWarsMusicTime', audio.currentTime.toString());
                });
                
                audio.addEventListener('play', function() {
                    localStorage.setItem('starWarsMusic', 'playing');
                });
                
                audio.addEventListener('pause', function() {
                    localStorage.setItem('starWarsMusic', 'stopped');
                });
            }
        }
        
        function updateUI() {
            if (audio && !audio.paused) {
                isPlaying = true;
                musicToggle.classList.add('playing');
                musicToggle.innerHTML = '<i class="fas fa-pause"></i>';
                musicStatus.textContent = 'Imperial March playing...';
            } else {
                isPlaying = false;
                musicToggle.classList.remove('playing');
                musicToggle.innerHTML = '<i class="fas fa-music"></i>';
                musicStatus.textContent = 'Music paused';
            }
        }
        
        function playMusic() {
            if (!audio) createAudio();
            
            audio.play().then(() => {
                isPlaying = true;
                updateUI();
            }).catch((error) => {
                console.log('Audio play failed:', error);
                musicStatus.textContent = 'Click to enable audio';
            });
        }
        
        function stopMusic() {
            if (audio) {
                audio.pause();
                // Don't reset time so music resumes from where it stopped
            }
            isPlaying = false;
            updateUI();
        }
        
        function toggleMusic() {
            if (isPlaying) {
                stopMusic();
            } else {
                playMusic();
            }
        }
        
        // Initialize
        musicToggle.addEventListener('click', toggleMusic);
        
        // Check if audio already exists and is playing
        if (audio) {
            updateUI();
        } else if (shouldAutoPlay) {
            createAudio();
        } else {
            // Preload audio on first interaction
            document.addEventListener('click', function() {
                if (!isLoaded && !audio) {
                    createAudio();
                }
            }, { once: true });
        }
        
        // Update UI based on existing audio state
        if (audio && !audio.paused) {
            isPlaying = true;
            updateUI();
        }
        
        // Save state when page unloads
        window.addEventListener('beforeunload', function() {
            if (audio && isPlaying) {
                localStorage.setItem('starWarsMusicTime', audio.currentTime.toString());
                localStorage.setItem('starWarsMusic', 'playing');
            }
        });
        
        // Update UI periodically to sync with audio state
        setInterval(function() {
            if (audio) {
                const audioIsPlaying = !audio.paused;
                if (audioIsPlaying !== isPlaying) {
                    isPlaying = audioIsPlaying;
                    updateUI();
                }
            }
        }, 500);
    })();
    </script>
    
    {{- partial "scriptsBodyEnd.html" . -}}
</body>
</html>
